#!/bin/bash
reset=$(tput sgr0)
red=$(tput setaf 1)
green=$(tput setaf 2)
magenta=$(tput setaf 5)
dirty="**dirty** Not updated."
current="Up to date!"

if [[ $# -gt 0 ]]; then
    target=$(realpath $1)
else
    target="$PWD"
fi

echo -e "\nUpdating clean repos in $magenta$target$reset\n"
(
cd "$target"
output="REPO|VERSION|BRANCH|RESULT\n"
for arg in $( ls ); do
    if [ -d "$arg" ] && [ -d "$arg/.git" ]; then
        tput el1
        tput hpa 0
        echo -n "Processing: $arg"
        cd "$arg"

        ver=$(getversion)
        branch=$(git current-branch)

        repo_info=$(echo "$arg|${ver}|$branch")

        if git isclean -q; then
            diff=$(git pull origin $branch 2>&1 | egrep '^Updating \w+\.\.\w+' | awk '{print $2}')
            if [ "x$diff" != "x" ]; then
                output+="$repo_info|Branch updated! Diff: $green$diff$reset\n"
            else
                output+="$repo_info|$current\n"
            fi
    	else
            output+="$repo_info|$red$dirty$reset\n"
        fi
        cd ".."
    fi
done
tput el1
tput hpa 0
echo -e "$output" | column -t -s "|"
echo -e "\n"
)
